name: Run Cypress Tests

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    cypress-tests:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Install dependencies
              run: npm install ts-node typescript

            - name: Run Cypress tests in Docker
              run: docker run -v ${{ github.workspace }}:/e2e -w /e2e cypress/included:13.3.3 npx ts-node cypress run

            - name: Store Test Results
              if: always()
              run: |
                  mkdir -p results
                  if [ -d "cypress/screenshots" ]; then cp -r cypress/screenshots results/screenshots; fi

            - name: Store Snapshots
              if: always()
              run: |
                  mkdir -p results/snapshots
                  SPEC_PATTERN="cypress/snapshots/*.spec.ts"
                  find cypress/snapshots -regextype posix-egrep -regex "$SPEC_PATTERN" -exec cp -r {} results/snapshots \;

            - name: Archive artifacts
              if: always()
              uses: actions/upload-artifact@v3.1.3
              with:
                  name: artifacts
                  path: results
                  retention-days: 10
